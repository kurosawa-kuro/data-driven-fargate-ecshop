generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:Nrp3FfO1goiB@ep-noisy-cherry-a7rp6riz.ap-southeast-2.aws.neon.tech/neondb?sslmode=require"
}

model User {
  // Cognitoとの連携のため修正
  id              String    @id           // CognitoのsubをIDとして使用
  email           String    @unique
  cognitoId       String    @unique      // Cognito User Pool IDとの紐付け
  
  // 認証関連の情報追加
  emailVerified   Boolean   @default(false)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // ステータス管理
  status          UserStatus @default(ACTIVE)  // ACTIVE, DISABLED, DELETED など

  // リレーション（既存）
  userRoles       UserRole[]
  viewHistories   ViewHistory[]
  cartItems       CartItem[]
  purchases       Purchase[]
  userActionLogs  UserActionLog[]
  returns         Return[]
}

enum UserStatus {
  ACTIVE
  DISABLED
  DELETED
}

model Role {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  userRoles       UserRole[]
}

model UserRole {
  userId          String
  roleId          Int
  assignedAt      DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
}


// 商品関連
model Product {
  id              Int       @id @default(autoincrement())
  name            String
  price           Float
  rating          Float
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // リレーション
  productCategories ProductCategory[]
  viewHistories   ViewHistory[]
  cartItems       CartItem[]
  purchaseItems   PurchaseItem[]
  userActionLogs  UserActionLog[]
  returnItems     ReturnItem[]
}
// カテゴリー
model Category {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  productCategories ProductCategory[]
}

model ProductCategory {
  productId       Int
  categoryId      Int
  assignedAt      DateTime  @default(now())
  
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  category        Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}


// 閲覧履歴（Random Forest, Logistic Regression用）
model ViewHistory {
  id          Int       @id @default(autoincrement())
  userId      String
  productId   Int
  viewedAt    DateTime  @default(now())

  // リレーション
  user        User      @relation(fields: [userId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])
  @@index([userId])
  @@index([productId])
  @@unique([userId, productId, viewedAt])
}

// カート（K-means用）
model CartItem {
  id          Int       @id @default(autoincrement())
  userId      String
  productId   Int
  quantity    Int       @default(1)
  addedAt     DateTime  @default(now())

  // リレーション
  user        User      @relation(fields: [userId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])
  userActionLogs UserActionLog[]
  @@index([userId])
  @@index([productId])
}

// 購入履歴（Linear Regression, PCA用）
model Purchase {
  id          Int       @id @default(autoincrement())
  userId      String
  totalAmount Float
  purchasedAt DateTime  @default(now())

  // リレーション
  user          User            @relation(fields: [userId], references: [id])
  purchaseItems PurchaseItem[]
  userActionLogs UserActionLog[]
  returns         Return[]
  @@index([userId])
}

// 購入商品詳細
model PurchaseItem {
  id          Int       @id @default(autoincrement())
  purchaseId  Int
  productId   Int
  quantity    Int
  price       Float     // 購入時の価格を保存

  // リレーション
  purchase    Purchase  @relation(fields: [purchaseId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])
  @@index([purchaseId])
  @@index([productId])
}

model UserActionLog {
  id          Int       @id @default(autoincrement())
  userId      String
  actionType  ActionType
  productId   Int?
  cartItemId  Int?
  purchaseId  Int?
  metadata    Json?     // 追加情報（価格変更、数量変更など）
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id])
  product     Product?  @relation(fields: [productId], references: [id])
  cartItem    CartItem? @relation(fields: [cartItemId], references: [id])
  purchase    Purchase? @relation(fields: [purchaseId], references: [id])

  @@index([userId, actionType, createdAt])
  @@index([productId])
  @@index([cartItemId])
  @@index([purchaseId])
}

enum ActionType {
  VIEW_PRODUCT
  ADD_TO_CART
  REMOVE_FROM_CART
  UPDATE_CART
  START_CHECKOUT
  COMPLETE_PURCHASE
  CANCEL_PURCHASE
  RETURN_REQUESTED
  RETURN_COMPLETED
}

model Return {
  id           Int       @id @default(autoincrement())
  purchaseId   Int
  userId       String
  returnedAt   DateTime  @default(now())
  status       ReturnStatus @default(REQUESTED)
  reason       String
  
  purchase     Purchase  @relation(fields: [purchaseId], references: [id])
  returnItems  ReturnItem[]
  user         User      @relation(fields: [userId], references: [id])

  @@index([purchaseId])
  @@index([userId])
}

model ReturnItem {
  id          Int       @id @default(autoincrement())
  returnId    Int
  productId   Int
  quantity    Int
  
  return      Return    @relation(fields: [returnId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([productId])
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  REJECTED
  COMPLETED
}